<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Календарь мероприятий — запись через форму</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#121826; --text:#e5e7eb; --muted:#9aa4b2; --brand:#7c3aed; --brand-2:#22d3ee; --ok:#10b981; --err:#ef4444;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:linear-gradient(135deg,var(--bg),#111827); color:var(--text)}
    .wrap{max-width:1100px; margin:40px auto; padding:0 16px}
    .header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px}
    h1{font-size:24px; margin:0; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:14px}
    .cal{display:grid; grid-template-columns: 300px 1fr; gap:18px}
    .panel{background:linear-gradient(180deg, rgba(124,58,237,.12), rgba(34,211,238,.08)); border:1px solid #1f2937; padding:16px; border-radius:var(--radius); box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .month-nav{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
    .month-nav button{background:#1f2937; border:1px solid #2a3443; color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer}
    .month{font-weight:600}
    .grid{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
    .dow{color:var(--muted); font-size:12px; text-align:center}
    .day{aspect-ratio:1/1; border:1px solid #243144; border-radius:10px; display:flex; align-items:flex-start; justify-content:flex-end; padding:6px; position:relative; background:#0f172a}
    .day.muted{opacity:.35}
    .day.today{border-color:var(--brand-2)}
    .dot{position:absolute; left:6px; bottom:6px; width:6px; height:6px; background:var(--brand); border-radius:999px}
    .sidebar .filter{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .tag{font-size:12px; padding:6px 8px; border:1px solid #2a3443; background:#0f172a; border-radius:999px; cursor:pointer}
    .tag.active{border-color:var(--brand); box-shadow:0 0 0 2px rgba(124,58,237,.25) inset}
    .events{display:flex; flex-direction:column; gap:10px; max-height:560px; overflow:auto; padding-right:6px}
    .event{border:1px solid #2a3443; background:#0f172a; border-radius:14px; padding:12px; display:grid; grid-template-columns: 1fr auto; gap:6px}
    .event h3{margin:0; font-size:15px}
    .event .meta{color:var(--muted); font-size:12px}
    .event .btn{align-self:center}
    .btn{background:linear-gradient(90deg,var(--brand),var(--brand-2)); color:#0b1020; font-weight:700; border:none; padding:10px 12px; border-radius:12px; cursor:pointer}
    .btn.ghost{background:#141b2b; color:var(--text); border:1px solid #2a3443}
    /* Modal */
    .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.55); padding:18px; z-index:50}
    .modal.open{display:grid}
    .sheet{width:min(560px,100%); background:#0b1222; border:1px solid #2a3443; border-radius:18px; padding:16px}
    .sheet h2{margin:0 0 8px 0}
    form{display:grid; gap:10px}
    label{font-size:13px; color:var(--muted)}
    input, select, textarea{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a3443; background:#0f172a; color:var(--text)}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .status{font-size:13px; margin-top:6px}
    .ok{color:var(--ok)}
    .err{color:var(--err)}
    .hr{height:1px; background:#1f2937; margin:8px 0}
    .small{font-size:12px; color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap" id="skillspace-booking-root">
    <div class="header">
      <div>
        <h1>Календарь мероприятий</h1>
        <div class="sub">Выберите дату и запишитесь через форму. Всё без сторонних библиотек — один файл ✨</div>
      </div>
      <button class="btn ghost" id="exportCsv">Экспорт записей (CSV)</button>
    </div>

    <div class="cal">
      <!-- Calendar panel -->
      <div class="panel">
        <div class="month-nav">
          <button id="prevMonth" aria-label="Предыдущий месяц">←</button>
          <div class="month" id="monthLabel"></div>
          <button id="nextMonth" aria-label="Следующий месяц">→</button>
        </div>
        <div class="grid" id="dow"></div>
        <div class="grid" id="days"></div>
      </div>

      <!-- Events panel -->
      <div class="panel sidebar">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px">
          <strong>События</strong>
          <button class="btn ghost" id="clearFilters">Сбросить фильтры</button>
        </div>
        <div class="filter" id="tagFilter"></div>
        <div class="events" id="events"></div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px">
        <div>
          <h2 id="modalTitle">Запись на событие</h2>
          <div class="small" id="modalMeta"></div>
        </div>
        <button class="btn ghost" id="closeModal">Закрыть</button>
      </div>
      <div class="hr"></div>
      <form id="bookingForm">
        <input type="hidden" name="event_id" id="event_id" />
        <div class="row">
          <div>
            <label>Имя</label>
            <input required name="name" placeholder="Иван Иванов" />
          </div>
          <div>
            <label>Email</label>
            <input required type="email" name="email" placeholder="name@example.com" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Телефон</label>
            <input name="phone" placeholder="+7 …" />
          </div>
          <div>
            <label>Тариф/билет</label>
            <select name="ticket" id="ticket"></select>
          </div>
        </div>
        <div>
          <label>Комментарий (необязательно)</label>
          <textarea name="note" rows="3" placeholder="Вопросы, пожелания…"></textarea>
        </div>
        <div style="display:flex; gap:10px; align-items:center; justify-content:flex-end">
          <button type="button" class="btn ghost" id="cancel">Отмена</button>
          <button class="btn" type="submit">Отправить заявку</button>
        </div>
        <div class="status" id="formStatus"></div>
      </form>
      <div class="small" style="margin-top:8px">Подтверждение придёт на email, если указан вебхук. По умолчанию заявки сохраняются локально в браузере (LocalStorage).</div>
    </div>
  </div>

  <script>
    /********************
     * КОНФИГ УСТАНОВКИ *
     ********************/
    const CONFIG = {
      // 1) Добавьте ваши события здесь. Можно любое кол-во тегов и тарифов.
      events: [
        {
          id: 'bx-bootcamp-1',
          title: 'Boxing Bootcamp',
          date: '2025-09-06', // YYYY-MM-DD (локаль не важна)
          time: '10:00–11:30',
          location: 'SADU Arena, Алматы',
          tags: ['Бокс', 'Bootcamp', 'Тренировка'],
          tickets: [
            { label: 'Разовое посещение', value: 'single', price: 5000 },
            { label: 'Абонемент 4 занятия', value: 'pass4', price: 16000 }
          ]
        },
        {
          id: 'nutri-talk-1',
          title: 'Открытая лекция по нутрициологии',
          date: '2025-09-12',
          time: '19:00–20:30',
          location: 'Онлайн (Zoom)',
          tags: ['Лекция', 'Онлайн'],
          tickets: [
            { label: 'Стандарт', value: 'std', price: 0 },
            { label: 'Поддержать проект', value: 'support', price: 3000 }
          ]
        },
        {
          id: 'coach-workshop-1',
          title: 'Воркшоп для тренеров: методика и продажи',
          date: '2025-09-20',
          time: '12:00–16:00',
          location: 'I‑Academy, Алматы',
          tags: ['Обучение', 'Оффлайн'],
          tickets: [
            { label: 'Базовый', value: 'basic', price: 15000 },
            { label: 'Премиум (с разбором)', value: 'premium', price: 30000 }
          ]
        }
      ],

      // 2) (Необязательно) Укажите URL вашего бэкенда/вебхука для заявок
      // Например: Formspree / Web3Forms / ваш сервер / Google Apps Script webhook
      // Если оставить пустым, заявки будут сохраняться в localStorage
      bookingWebhook: '',

      // 3) Название проекта в CSV экспорте
      projectName: 'Skillspace-Calendar'
    };

    /*********************
     * ХЕЛПЕРЫ ДАТ/ФОРМАТ *
     *********************/
    const MONTHS = ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
    const DOW = ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'];

    function parseDate(str){ // YYYY-MM-DD -> Date (local)
      const [y,m,d] = str.split('-').map(Number);
      return new Date(y, m-1, d);
    }
    function fmtDateHuman(str){ const d=parseDate(str); return `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}` }

    /**********************
     * СОСТОЯНИЕ ПРИЛОЖЕНИЯ *
     **********************/
    const state = {
      current: new Date(),
      activeDate: null,
      activeTags: new Set(),
      eventsByDay: new Map()
    };

    // Индексация событий по дню
    function indexEvents(){
      state.eventsByDay.clear();
      CONFIG.events.forEach(ev=>{
        const key = ev.date;
        if(!state.eventsByDay.has(key)) state.eventsByDay.set(key, []);
        state.eventsByDay.get(key).push(ev);
      });
    }

    /**************
     * РЕНДЕР UI *
     **************/
    function renderDow(){
      const el = document.getElementById('dow'); el.innerHTML='';
      DOW.forEach(n=>{ const s=document.createElement('div'); s.className='dow'; s.textContent=n; el.appendChild(s); })
    }

    function renderMonth(){
      const ym = new Date(state.current.getFullYear(), state.current.getMonth(), 1);
      document.getElementById('monthLabel').textContent = `${MONTHS[ym.getMonth()]} ${ym.getFullYear()}`;

      const daysEl = document.getElementById('days');
      daysEl.innerHTML='';

      // Определяем смещение на первый будний столбец: Пн=0 … Вс=6
      let first = new Date(ym);
      let firstIdx = (first.getDay() + 6) % 7; // JS: Вс=0, смещаем
      const daysInMonth = new Date(ym.getFullYear(), ym.getMonth()+1, 0).getDate();

      // Предыдущие дни (немного для сетки)
      const prevMonthDays = new Date(ym.getFullYear(), ym.getMonth(), 0).getDate();

      // Рисуем 6 строк по 7 дней = 42 ячейки
      for(let i=0;i<42;i++){
        const cell = document.createElement('button');
        cell.className='day';
        const dayNum = i - firstIdx + 1;
        let day, isMuted=false, dateStr;
        if(dayNum <= 0){
          // пред. месяц
          isMuted = true;
          day = prevMonthDays + dayNum;
          const d = new Date(ym.getFullYear(), ym.getMonth()-1, day);
          dateStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        } else if (dayNum > daysInMonth){
          // след. месяц
          isMuted = true;
          const d = new Date(ym.getFullYear(), ym.getMonth()+1, dayNum - daysInMonth);
          day = d.getDate();
          dateStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        } else {
          // текущий месяц
          day = dayNum;
          dateStr = `${ym.getFullYear()}-${String(ym.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        }

        if(isMuted) cell.classList.add('muted');
        const today = new Date();
        const isToday = (new Date(dateStr)).toDateString() === new Date(today.getFullYear(), today.getMonth(), today.getDate()).toDateString();
        if(isToday) cell.classList.add('today');

        cell.dataset.date = dateStr;
        cell.innerHTML = `<span>${day}</span>`;

        // Точки, если есть события
        const list = state.eventsByDay.get(dateStr) || [];
        if(list.length){
          const dot = document.createElement('div'); dot.className='dot'; cell.appendChild(dot);
        }

        cell.addEventListener('click', ()=>{
          state.activeDate = dateStr;
          renderEvents();
          // прокрутить список к первому событию
          setTimeout(()=>{
            const firstEv = document.querySelector('.event');
            if(firstEv) firstEv.scrollIntoView({behavior:'smooth', block:'start'});
          }, 0);
        });

        daysEl.appendChild(cell);
      }
    }

    function renderTagFilter(){
      const el = document.getElementById('tagFilter');
      el.innerHTML='';
      const tags = new Set();
      CONFIG.events.forEach(e=> e.tags?.forEach(t=> tags.add(t)));
      Array.from(tags).sort().forEach(tag=>{
        const b = document.createElement('button');
        b.className = 'tag' + (state.activeTags.has(tag) ? ' active' : '');
        b.textContent = tag;
        b.addEventListener('click', ()=>{ if(state.activeTags.has(tag)) state.activeTags.delete(tag); else state.activeTags.add(tag); renderEvents(); renderTagFilter(); });
        el.appendChild(b);
      });
    }

    function renderEvents(){
      const el = document.getElementById('events');
      el.innerHTML='';

      let list = CONFIG.events.slice().sort((a,b)=> a.date.localeCompare(b.date));
      if(state.activeDate) list = list.filter(e=> e.date === state.activeDate);
      if(state.activeTags.size) list = list.filter(e=> e.tags?.some(t=> state.activeTags.has(t)));

      if(!list.length){
        el.innerHTML = `<div class="small">Нет событий по выбранным фильтрам.</div>`;
        return;
      }

      list.forEach(ev=>{
        const card = document.createElement('div'); card.className='event';
        const priceRange = ev.tickets?.length ? `${Math.min(...ev.tickets.map(t=>t.price))}₸${Math.max(...ev.tickets.map(t=>t.price))!==Math.min(...ev.tickets.map(t=>t.price)) ? '–'+Math.max(...ev.tickets.map(t=>t.price))+'₸' : ''}` : '';
        card.innerHTML = `
          <div>
            <h3>${ev.title}</h3>
            <div class="meta">${fmtDateHuman(ev.date)} · ${ev.time} · ${ev.location}${priceRange? ' · от ' + priceRange : ''}</div>
            ${ev.tags?.length ? `<div class="small">Теги: ${ev.tags.join(', ')}</div>` : ''}
          </div>
          <div class="btn-wrap"><button class="btn" data-ev="${ev.id}">Записаться</button></div>
        `;
        card.querySelector('button').addEventListener('click', ()=> openModal(ev));
        el.appendChild(card);
      });
    }

    /****************
     * МОДАЛ & ФОРМА *
     ****************/
    const modal = document.getElementById('modal');

    function openModal(ev){
      document.getElementById('event_id').value = ev.id;
      document.getElementById('modalTitle').textContent = ev.title;
      document.getElementById('modalMeta').textContent = `${fmtDateHuman(ev.date)} · ${ev.time} · ${ev.location}`;
      const sel = document.getElementById('ticket'); sel.innerHTML='';
      (ev.tickets||[{label:'Стандарт', value:'std', price:0}]).forEach(t=>{
        const o=document.createElement('option'); o.value=t.value; o.textContent=`${t.label}${typeof t.price==='number' ? ' — ' + t.price + '₸' : ''}`; sel.appendChild(o);
      });
      document.getElementById('formStatus').textContent='';
      modal.classList.add('open');
    }
    function closeModal(){ modal.classList.remove('open'); }

    document.getElementById('closeModal').addEventListener('click', closeModal);
    document.getElementById('cancel').addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });

    document.getElementById('bookingForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const form = e.currentTarget;
      const data = Object.fromEntries(new FormData(form).entries());
      const eventObj = CONFIG.events.find(x=> x.id===data.event_id);
      const payload = {
        ...data,
        submitted_at: new Date().toISOString(),
        event_title: eventObj?.title,
        event_date: eventObj?.date,
        event_time: eventObj?.time,
        event_location: eventObj?.location
      };
      const status = document.getElementById('formStatus');

      try{
        if(CONFIG.bookingWebhook){
          const res = await fetch(CONFIG.bookingWebhook, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          if(!res.ok) throw new Error('HTTP '+res.status);
          status.innerHTML = `<span class="ok">Заявка отправлена. Проверьте почту.</span>`;
        } else {
          // Фолбэк: сохраняем локально
          const key = 'skillspace-bookings';
          const list = JSON.parse(localStorage.getItem(key)||'[]');
          list.push(payload);
          localStorage.setItem(key, JSON.stringify(list));
          status.innerHTML = `<span class="ok">Заявка сохранена локально (без вебхука).</span>`;
        }
        form.reset();
        setTimeout(closeModal, 800);
      } catch(err){
        console.error(err);
        status.innerHTML = `<span class="err">Ошибка отправки. Попробуйте еще раз.</span>`;
      }
    });

    /*******************
     * ЭКСПОРТ В CSV   *
     *******************/
    document.getElementById('exportCsv').addEventListener('click', ()=>{
      const key = 'skillspace-bookings';
      const list = JSON.parse(localStorage.getItem(key)||'[]');
      if(!list.length){ alert('Нет локально сохранённых заявок.'); return; }
      const cols = ['submitted_at','event_id','event_title','event_date','event_time','event_location','name','email','phone','ticket','note'];
      const escape = v => '"' + String(v??'').replaceAll('"','""') + '"';
      const csv = [cols.join(',')].concat(list.map(r=> cols.map(c=> escape(r[c])).join(','))).join('\n');
      const blob = new Blob([`\uFEFF# ${CONFIG.projectName} — Bookings\n`+csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`${CONFIG.projectName}_bookings.csv`; a.click(); URL.revokeObjectURL(url);
    });

    /*******************
     * ИНИЦИАЛИЗАЦИЯ   *
     *******************/
    document.getElementById('prevMonth').addEventListener('click', ()=>{ state.current = new Date(state.current.getFullYear(), state.current.getMonth()-1, 1); renderMonth(); });
    document.getElementById('nextMonth').addEventListener('click', ()=>{ state.current = new Date(state.current.getFullYear(), state.current.getMonth()+1, 1); renderMonth(); });
    document.getElementById('clearFilters').addEventListener('click', ()=>{ state.activeDate=null; state.activeTags.clear(); renderEvents(); renderTagFilter(); });

    function init(){
      indexEvents();
      renderDow();
      renderMonth();
      renderTagFilter();
      renderEvents();
    }

    init();
  </script>
</body>
</html>
